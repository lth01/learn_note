---
Date: 2024-03-19
reference: 스프링 DB 1편 - 인프런
---
## 걔념
트랜잭션이란 하나의 작업처럼 동작하기 위해 수행되어야하는 쿼리들의 집합을 의미한다.

A -> B에게 5,000원을 이체한다 생각해보자.

이체과정은 다음과같이 이뤄질 것이다.

1. A의 계좌에서 5,000원을 출금
2. B의 계좌에 5,000원을 입금

그렇다면 1의 과정 중 문제가 발생했을 때, A의 계좌에 다시 5,000원을 채우지 않으면 5,000원은 증발될 것이다.

모든 작업이 완료되었을 때, 변경사항을 반영하는 것을 `커밋` 이라하고 작업중 실패사항이 생겨 거래 이전으로 돌아가는 것을 `롤백`이라한다.

### ACID
트랜잭션은 반드시 지켜야할 4가지 속성이 있다.

1. 원자성(Atomicity): 트랜잭션 내에서 실행한 작업들은 마치 하나의 작업처럼 모두 성공하거나 모두 실패해야한다.
2. 일관성(Consistency):모든 트랜잭션은 일관성 있는 데이터베이스 상태를 유지해야한다. 예를들어 데이터베이스에서 정한 무결성 제약 조건을 항상 만조해야함
3. 격리성(Isolation): 동시에 실행되는(실행시간이 겹치는) 트랜잭션이 서로에게 영향을 끼치면 안된다.
	- 격리성은 트랜잭션 격리 수준(Isolation level, lock)을 선택할 수 있다.
4. 지속성(Durability):트랜잭션을 성공적으로 끝내면, 항상 그 결과는 기록되어야한다. 중간 시스템에 문제가 생겨도 로그등을 통해 트랜잭션 내용을 복구해야한다.


## 사용법
데이터 변경 쿼리를 실한하고 DB에 결과를 반영하려면, `commit`을 호출하고, 결과를 반영하고싶지 않다면 롤백 명령어인 `rollback`을 호출하면됨
- DBeaver, PgAdmin등 DBMS GUI은 기본적으로 자동 커밋이 켜져있음

커밋하기 이전까지는 세션별 변경 예정인 데이터를 임시 저장하고있는다. 다른 세션에서는 변경 예정 데이터가 보이지 않음

### 세션간 데이터 격리가 일어나지 않을 경우 어떤일이 발생하는가?
세션간 커밋전까지 데이터 격리가 일어나지 않는다 가정했을 때

세션 1에서 새로운 계정을 추가한다 가정하자

| 이름  | 아이디  |
| ---- | ---- |
| 김아무개 | abcd |
| 홍길동  | efgh |

세션1은 이름: 라이언, 아이디: lion이란 계정을 추가하려고 일련의 로직을 수행중이다.

세션2가 세션1의 트랜젝션이 수행완료되기 전까지 정보를 볼 수 있을 경우

| 이름  | 아이디  |
| ---- | ---- |
| 김아무개 | abcd |
| 홍길동  | efgh |
| 라이언  | lion |

이렇게 나올 것이다. **세션2가 아직 생성되지 않은 라이언의 정보를 가지고 로직을 수행할 경우 어떤 문제가 발생할지 우리는 알 수 없다!**


## DB 락
세션이 트랜잭션을 시작하고 데이터를 수정하는 동안 아직 커밋을 수행하지 않았는데, 세션2에서 동시에 같은 데이터를 수정하면 여러가지 문제가 발생함.

따라서 트랜잭션을 시작하고 데이터를 수정하는 동안 커밋이나 롤백 전까지 다른 세션이 데이터를 수정하지 못하게 막아져야함

**DBMS는 이런 문제를 해결하기 위해 락(lock)을 제공**

락은 로우의 데이터를 수정할 수 있는 일종의 티켓이다. 먼저 선입된 트랜잭션이 락을 획득하면 다른 트랜잭션들이 동일한 데이터를 수정하려 할 때 락을 갖고있는 트랜잭션이 완료될 때까지 기다려야한다.

락도 다양한 종류가 존재한다.

### 락의 종류
#### 조회락
데이터 조회하고, 커밋할 때까지 데이터 조작이 일어나면 안되는 경우 select for update 구문을 통해 조회시점에 락을 가져갈 수 있다.
- MSSQL2008은... 자동 조회락이 있었지

