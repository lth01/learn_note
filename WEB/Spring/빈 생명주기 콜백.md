---
Date: 2024-03-13
reference: 스프림 핵심 원리 - 기본편
---

## 빈 생명주기 콜백 시작
DB 커넥션 풀, 네트워크 소켓처럼 앱 시작시 미리 필요한 연결을 해두고, 애플리케이션 종료시점에 연결을 모두 종료하는 작업을 진행하려면 객체의 초기화와 종료 작업이 필요함
- 내가 구현한다면 각 객체에서 초기화,종료호출을 진행했을것이다.


스프링 빈은 다음과 같은 라이프 사이클을 가진다.
**"객체생성" -> "의존관계 주입"**

스프링 빈은 객체를 생성하고, 의존관계 주입이 다 끝난 다음에 필요한 데이터를 사용할 수 있는 준비가 완료된다. 

따라서, 초기화 작업은 의존 관계 주입이 완료된 이후에 객체가 사용되기 전 이루어져야한다.

### 개발자는 어떻게 의존관계 주입 완료시점을 알 수 있는가
스프링은 의존관계 주입이 완료되면, 스프링 빈에게 **콜백 메서드**를 통해 초기화 시점을 알려주는 다양한 기능을 제공한다.
또한 스프링 컨테이너가 종료되기 직전에 **소멸 콜백**을 준다. 따라서, 안전하게 작업 진행이 가능하다.

### 스프링 빈 이벤트 라이프 사이클
**스프링 컨테이너 생성 -> 스프링 빈 생성 -> 의존관계 주입 -> 초기화 콜백 -> 사용 -> 소멸 전 콜백 -> 스프링 종료**

#### 참고: 객체 생성과 초기화를 분리하자
생성자는 필수 정보를 받고 메모리를 할당해서 객체를 생성하는 책임을 가진다.
반면에 초기화는 이렇게 생성된 값들을 사용하여 외부 커넥션 연결하는 등 무거운 동작을 수행한다.

따라서, 무거운 초기화 작업을 생성자 안에서 처리하는 것 보다 초기화 과정을 분리하는 것이 유지보수에 좋다.
-> lazy loading같은게 가능

### 빈 생명 주기 콜백 종류
1. 인터페이스(InitializingBean, DisposableBean)
2. 설정 정보에 초기화 메서드, 종료 메서드 지정
3. `@PostConstruct`, `@PreDestroy` 어노테이션 지정


#### 인터페이스
InitializingBean, DisposableBean의 메서드를 오버라이딩해서 빈 반환 및 컨테이너 삭제 전 초기화 호출을 진행하도록 한다.

하지만 
1.인터페이스로 코드에 구현함으로써 스프링 의존성이 생긴다.
2.초기화, 소멸 메서드의 이름을 변경할 수 없다.
3.내가 코드를 고칠 수 없는 외부라이브러에 적용할 수 없다.

> 참고: 더 나은 방법들이 있어 거의 사용하지 않는다.

### 빈 등록 초기화, 소멸 메소드
초기화, 소멸 메서드를 빈 내부에 작성한다.


```java
public class Client{
	public void init(){
	%% blabla %%
	}
	
	public void destroy(){
	%% blabla %%
	}
}
```

이후 초기화, 소멸 작업이 필요한 빈 클래스에 initMethod, destroyMethod를 아래와 같이 지정한다.

```java

@Configuration
static class LifeCycleConfig{
	@Bean(initMethod = "init", destoryMethod = "close")
	public Client client(){
		Client newClient = new Client();
		newClient.doSomeThing();//수행이 보장된다.
		return newClient;
	}
}
```

특징은 아래와 같다.
1. 메서드 이름을 자유롭게 줄 수 있다.
2. 스프링빈이 스프링 코드에 의존하지 않는다.
3. 코드가 아니라 설정정보(레플렉션을 사용)하기 때문에 코드를 고칠 수 없는 외부라이브러에도 초기화, 종료 메서드를 적용할 수 있다.
	- 장점!
4. `@Bean` 어노테이션의 destroyMethod는 아주 특별한 기능이 있다.
	- 대부분의 라이브러리는 close,shutdown 이름의 종료메서드를 사용한다.
	- 스프링 빈은 소멸 메서드로 close, shutdown 이름의 메서드를 자동으로 호출한다(있다면).
	- 만약 소멸자가 불리지 않길 원하면 `destroyMethod=""`로 등록하면된다.

> 참고!
> 소멸자를 추론하는 것은 Bean의 구현체를 DisaposableBeanAdapter에서 확인할 수 있다!


### 어노테이션 `@PostConstruct`, `@PreDestroy`
**스프링이 권고하는 방법**

초기화 할때, 소멸시켜야할 때 각각 어노테이션을 처리한다.

장점
1. 스프링 종속적인 기술이 아니다. 다른 컨테이너에서도 잘 동작한다.
2. 컴포넌트 스캔과 잘 어울린다.

단점
1. 외부 라이브러리에는 적용하지 못한다.